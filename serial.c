//------------------------------------------------------------------------------
//             __             __   ___  __
//     | |\ | /  ` |    |  | |  \ |__  /__`
//     | | \| \__, |___ \__/ |__/ |___ .__/
//
//------------------------------------------------------------------------------

#include "serial.h"
#include <avr/io.h>
#include <avr/interrupt.h>

//------------------------------------------------------------------------------
//      __   ___  ___         ___  __
//     |  \ |__  |__  | |\ | |__  /__`
//     |__/ |___ |    | | \| |___ .__/
//
//------------------------------------------------------------------------------

#define MAX_STRING_SIZE (500)

//------------------------------------------------------------------------------
//     ___      __   ___  __   ___  ___  __
//      |  \ / |__) |__  |  \ |__  |__  /__`
//      |   |  |    |___ |__/ |___ |    .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//                __          __        ___  __
//     \  /  /\  |__) |  /\  |__) |    |__  /__`
//      \/  /~~\ |  \ | /~~\ |__) |___ |___ .__/
//
//------------------------------------------------------------------------------

static char serial_string[MAX_STRING_SIZE]; //volatile?
static volatile char read = 0;
static volatile uint8_t busy = 0;
static volatile uint8_t index = 0;

//------------------------------------------------------------------------------
//      __   __   __  ___  __  ___      __   ___  __
//     |__) |__) /  \  |  /  \  |  \ / |__) |__  /__`
//     |    |  \ \__/  |  \__/  |   |  |    |___ .__/
//
//------------------------------------------------------------------------------
char serial_read();
//------------------------------------------------------------------------------
//      __        __          __
//     |__) |  | |__) |    | /  `
//     |    \__/ |__) |___ | \__,
//
//------------------------------------------------------------------------------

//==============================================================================
void serial_init()
{
  // USART0 initialization
  // Communication Parameters: 8 Data, 1 Stop, No Parity
  // USART0 Receiver: On
  // USART0 Transmitter: On
  // USART0 Mode: Asynchronous
  // USART0 Baud Rate: 9600
  UCSR0A=(0<<RXC0) | (0<<TXC0) | (0<<UDRE0) | (0<<FE0) | (0<<DOR0) | (0<<UPE0) | (0<<U2X0) | (0<<MPCM0);
  //transfer and recieve interrupt bits
  UCSR0B=(1<<RXCIE0) | (1<<TXCIE0) | (0<<UDRIE0) | (1<<RXEN0) | (1<<TXEN0) | (0<<UCSZ02) | (0<<RXB80) | (0<<TXB80);
  UCSR0C=(0<<UMSEL01) | (0<<UMSEL00) | (0<<UPM01) | (0<<UPM00) | (0<<USBS0) | (1<<UCSZ01) | (1<<UCSZ00) | (0<<UCPOL0);
  UBRR0H=0x00;
  UBRR0L=0x00; //67
}

//=============================================================================
void serial_write(uint8_t data)
{
  // Put data into buffer, sends the data
  UDR0 = data;
}

//=============================================================================

uint8_t serial_string_write(char * in_string) // or in_string[]
{
  uint8_t ret_val = 0;
  
  if( !busy)
  {
    while( serial_string[index] = in_string[index++]);

    index = 0;

    if(serial_string[index]) 		// If this is the first character.
    {
      serial_write(serial_string[index]);
      index ++;
      busy = 1;
    }
  }
  else
  {
    ret_val = busy; //1
  }
  return ret_val;
}


//=============================================================================

char serial_read()
{
  char retval = read;
  
  // Kill old read value
  read = 0;
  
  return retval;
}

//=============================================================================


//------------------------------------------------------------------------------
//      __   __              ___  ___
//     |__) |__) | \  /  /\   |  |__
//     |    |  \ |  \/  /~~\  |  |___
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//      __                  __        __        __
//     /  `  /\  |    |    |__)  /\  /  ` |__/ /__`
//     \__, /~~\ |___ |___ |__) /~~\ \__, |  \ .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//        __   __  , __
//     | /__` |__)  /__`
//     | .__/ |  \  .__/
//
//------------------------------------------------------------------------------

ISR(USART_TX_vect) // serial transfer complete
{
  if(serial_string [index]) 		// If this is the first character.
  {
    serial_write(serial_string[index]);
    index ++;
    busy = 1;
  }
  else
  {
    busy = 0;
    index = 0;
  }
}

ISR(USART_RX_vect) //serial read complete
{
  // Get and return received data from buffer
  //won't transmit until enter is hit
  read = UDR0;
}